<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Battle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
:root {
    --bg:#080B14; --surf:#0F1525; --surf2:#161E34; --surf3:#1C2540;
    --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.13);
    --text:#EEF0FF; --muted:rgba(200,205,255,0.5); --muted2:rgba(200,205,255,0.25);
    --accent:#5B6EF5; --accent2:#F06292; --gold:#FFD54F;
    --success:#43D98E; --danger:#F06060; --r:20px; --r2:12px;
}
html,body{height:100%;background:var(--bg)}
body{font-family:'Space Grotesk',sans-serif;color:var(--text);min-height:100vh;overflow-x:hidden;position:relative}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 10% -10%,rgba(91,110,245,.18) 0%,transparent 60%),radial-gradient(ellipse 60% 50% at 90% 110%,rgba(240,98,146,.12) 0%,transparent 55%);pointer-events:none;z-index:0}
.wrap{max-width:540px;margin:0 auto;padding:20px 16px 56px;min-height:100vh;position:relative;z-index:1}
.state{display:none}
.state.active{display:flex;flex-direction:column;align-items:center;animation:fadeUp .4s cubic-bezier(.22,1,.36,1)}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* LOADING */
#s-loading{justify-content:center;min-height:80vh}
.spinner{width:44px;height:44px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .75s linear infinite;margin-bottom:16px}
@keyframes spin{to{transform:rotate(360deg)}}
.load-txt{color:var(--muted);font-size:14px}

/* ERROR */
#s-error{justify-content:center;min-height:80vh}
.err-box{background:var(--surf);border:1px solid rgba(240,96,96,.25);border-radius:var(--r);padding:44px 32px;text-align:center;max-width:340px}
.err-icon{font-size:40px;margin-bottom:12px}
.err-box h2{font-family:'Outfit',sans-serif;font-size:22px;color:var(--danger);margin-bottom:8px}
.err-box p{color:var(--muted);font-size:14px;line-height:1.6}
.err-box .err-hint{margin-top:16px;padding:12px 16px;background:rgba(91,110,245,.08);border:1px solid rgba(91,110,245,.2);border-radius:12px;font-size:13px;color:#a0aaff;line-height:1.5}

/* LOBBY */
#s-lobby{justify-content:flex-start;padding-top:16px;gap:20px;width:100%}
.lobby-head{width:100%;text-align:center;padding:16px 8px 4px}
.quiz-badge{display:inline-block;font-family:'Outfit',sans-serif;font-size:11px;font-weight:700;letter-spacing:2.5px;color:var(--accent);background:rgba(91,110,245,.12);border:1px solid rgba(91,110,245,.28);padding:4px 14px;border-radius:50px;margin-bottom:12px}
.lobby-head h1{font-family:'Outfit',sans-serif;font-size:26px;font-weight:900;line-height:1.2;background:linear-gradient(135deg,#fff 0%,#aab0ff 55%,var(--accent2) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.quiz-meta-row{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.quiz-meta-pill{display:inline-flex;align-items:center;gap:5px;background:var(--surf2);border:1px solid var(--border2);border-radius:50px;padding:4px 12px;font-size:12px;font-weight:600;color:var(--muted)}
.quiz-meta-pill span{color:var(--text)}
.room-badge{display:inline-flex;align-items:center;gap:8px;background:var(--surf2);border:1px solid var(--border2);border-radius:50px;padding:6px 16px;font-size:13px}
.room-label{color:var(--muted)}
.room-badge strong{font-family:'Outfit',sans-serif;font-size:15px;font-weight:700;color:var(--gold);letter-spacing:1px}
.sec-head{width:100%;display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.sec-title{font-family:'Outfit',sans-serif;font-size:18px;font-weight:700}
.count-badge{background:var(--surf2);border:1px solid var(--border2);border-radius:50px;padding:4px 12px;font-size:12px;font-weight:600;color:var(--muted)}

/* TEAM SELECT GRID */
.team-sel-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;width:100%;margin-bottom:14px}
.tsc{position:relative;background:var(--surf);border:1.5px solid var(--border2);border-radius:18px;padding:20px 12px 16px;text-align:center;overflow:hidden;cursor:pointer;transition:transform .2s,border-color .2s,box-shadow .2s}
.tsc::before{content:'';position:absolute;inset:0;background:var(--tc,var(--accent));opacity:.06;transition:opacity .2s}
.tsc:hover{transform:translateY(-3px);border-color:var(--tc,var(--accent));box-shadow:0 8px 28px rgba(0,0,0,.4),0 0 0 1px var(--tc,var(--accent))}
.tsc:hover::before{opacity:.1}
.tsc-glow{position:absolute;top:-30px;left:50%;transform:translateX(-50%);width:80px;height:80px;background:var(--tc,var(--accent));border-radius:50%;filter:blur(28px);opacity:.18;pointer-events:none}
.tsc-emoji{font-size:36px;margin-bottom:8px;position:relative;z-index:1}
.tsc-name{font-family:'Outfit',sans-serif;font-size:15px;font-weight:700;margin-bottom:4px;position:relative;z-index:1}
.tsc-cnt{font-size:11px;color:var(--muted);margin-bottom:4px;position:relative;z-index:1}
.tsc-players{font-size:10px;color:var(--muted2);margin-bottom:8px;position:relative;z-index:1;min-height:14px}
.tsc-btn{position:relative;z-index:1;width:100%;padding:8px 0;background:var(--tc,var(--accent));color:#fff;font-family:'Outfit',sans-serif;font-size:13px;font-weight:700;border:none;border-radius:50px;cursor:pointer;transition:opacity .2s,transform .15s}
.tsc-btn:hover{opacity:.85;transform:scale(1.03)}

/* TEAMS GRID */
.teams-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:12px;width:100%;margin-bottom:14px}
.team-card{background:var(--surf);border:1.5px solid var(--border2);border-top:3px solid var(--tc,var(--accent));border-radius:16px;padding:14px;transition:transform .2s}
.team-card:hover{transform:translateY(-2px)}
.tc-top{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.tc-emoji{font-size:22px}
.tc-info{flex:1;min-width:0}
.tc-name{display:block;font-family:'Outfit',sans-serif;font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tc-count{display:inline-block;font-size:10px;color:var(--muted);background:var(--surf2);border-radius:50px;padding:1px 7px;margin-top:2px}
.tc-players{display:flex;flex-direction:column;gap:5px}
.p-chip{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--surf2);border-radius:8px;font-size:12px;font-weight:500;animation:chipIn .25s ease}
.p-chip.me{background:rgba(91,110,245,.1);border:1px solid rgba(91,110,245,.3)}
.p-chip em{font-style:normal;color:var(--muted)}
.p-av{width:22px;height:22px;flex-shrink:0;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:#fff}
.no-p{font-size:11px;color:var(--muted2);text-align:center;padding:6px 0}
@keyframes chipIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}

/* SWITCH TEAM BUTTON */
.switch-team-wrap{width:100%;margin-bottom:8px}
.switch-team-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:8px;padding:11px;background:rgba(91,110,245,.07);border:1.5px solid rgba(91,110,245,.25);border-radius:12px;color:#a0aaff;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;margin-bottom:4px}
.switch-team-btn:hover{border-color:var(--accent);background:rgba(91,110,245,.13);color:#fff}

.add-team-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:8px;padding:13px;background:transparent;border:2px dashed rgba(91,110,245,.3);border-radius:14px;color:var(--accent);font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;margin-bottom:14px}
.add-team-btn:hover{border-color:var(--accent);background:rgba(91,110,245,.07);transform:translateY(-1px)}
.start-btn{width:100%;padding:17px;font-family:'Outfit',sans-serif;font-size:16px;font-weight:800;background:linear-gradient(135deg,var(--accent) 0%,#8B5CF6 50%,var(--accent2) 100%);color:#fff;border:none;border-radius:14px;cursor:pointer;transition:all .3s;box-shadow:0 4px 20px rgba(91,110,245,.25)}
.start-btn:not(:disabled):hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(91,110,245,.4)}
.start-btn:disabled{opacity:.35;cursor:not-allowed;box-shadow:none}

/* MODAL */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(8px);z-index:500;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease}
.modal-ov.open{opacity:1;pointer-events:all}
.modal-ov.open .modal-box{transform:translateY(0)}
.modal-box{background:var(--surf);border:1px solid var(--border2);border-radius:24px 24px 0 0;width:100%;max-width:540px;transform:translateY(100%);transition:transform .38s cubic-bezier(.22,1,.36,1);overflow:hidden;display:flex;flex-direction:column;max-height:90vh}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:22px 24px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-hd h3{font-family:'Outfit',sans-serif;font-size:18px;font-weight:700}
.modal-x{width:32px;height:32px;background:var(--surf2);border:1px solid var(--border2);border-radius:50%;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.modal-x:hover{background:var(--surf3);color:var(--text)}
.modal-bd{padding:24px;display:flex;flex-direction:column;align-items:center;gap:12px;overflow-y:auto;flex:1}
.m-preview{font-size:52px;line-height:1;filter:drop-shadow(0 4px 16px rgba(0,0,0,.3))}
.m-hint{font-size:13px;color:var(--muted);text-align:center}
.m-input{width:100%;padding:14px 18px;background:var(--surf2);border:1.5px solid var(--border2);border-radius:var(--r2);color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:500;outline:none;transition:border-color .2s,box-shadow .2s;caret-color:var(--accent)}
.m-input::placeholder{color:var(--muted2)}
.m-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(91,110,245,.15)}
.m-actions{width:100%;display:flex;gap:10px;padding-bottom:env(safe-area-inset-bottom,0);flex-shrink:0;padding:0 24px 24px}
.m-cancel{flex:1;padding:13px;background:var(--surf2);border:1px solid var(--border2);border-radius:var(--r2);color:var(--muted);font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.m-cancel:hover{background:var(--surf3);color:var(--text)}
.m-confirm{flex:2;padding:13px;background:linear-gradient(135deg,var(--accent),#8B5CF6);border:none;border-radius:var(--r2);color:#fff;font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s}
.m-confirm:hover{opacity:.88;transform:translateY(-1px)}

/* SWITCH TEAM MODAL */
#modal-switch .tsc-btn { margin-top: 4px; }

/* STATS MODAL */
#modal-stats .modal-box{max-height:90vh}
.stats-scroll{overflow-y:auto;flex:1;padding:0 20px 28px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.stats-scroll::-webkit-scrollbar{width:4px}
.stats-scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
.stats-q-block{margin-bottom:16px;background:var(--surf2);border-radius:14px;padding:16px}
.stats-q-num{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px}
.stats-q-text{font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;margin-bottom:8px;line-height:1.4;border-bottom:1px solid var(--border);padding-bottom:10px}
.stats-correct-ans{font-size:11px;color:var(--success);background:rgba(67,217,142,.1);border-radius:6px;padding:4px 10px;margin-bottom:12px;display:inline-block}
.stats-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;font-size:13px}
.stats-row:last-child{margin-bottom:0}
.s-av{width:26px;height:26px;flex-shrink:0;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:#fff}
.s-name{flex:1;font-weight:500}
.s-badge{padding:3px 9px;border-radius:50px;font-size:11px;font-weight:700}
.s-badge.ok{background:rgba(67,217,142,.15);color:var(--success)}
.s-badge.no{background:rgba(240,96,96,.15);color:var(--danger)}
.s-badge.sk{background:rgba(200,205,255,.08);color:var(--muted)}
.s-pts{font-family:'Outfit',sans-serif;font-weight:700;font-size:13px;min-width:52px;text-align:right}
.s-pts.earned{color:var(--gold)}
.s-pts.zero{color:var(--muted2)}

/* COUNTDOWN */
#s-cd{justify-content:center;min-height:80vh}
.cd-wrap{position:relative;text-align:center;display:flex;flex-direction:column;align-items:center;gap:8px}
.cd-label{font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:3px}
.cd-num{font-family:'Outfit',sans-serif;font-size:120px;font-weight:900;line-height:1;background:linear-gradient(135deg,#fff 0%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative;z-index:2}
@keyframes cdPulse{0%{transform:scale(.4);opacity:0;filter:blur(20px)}55%{transform:scale(1.12);opacity:1;filter:blur(0)}100%{transform:scale(1);opacity:1}}
.cd-rings{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}
.ring{position:absolute;border-radius:50%;border:2px solid rgba(91,110,245,.15);transform:translate(-50%,-50%)}
.r1{width:170px;height:170px;animation:rp 2s infinite 0s}
.r2{width:230px;height:230px;animation:rp 2s infinite .3s}
.r3{width:290px;height:290px;animation:rp 2s infinite .6s}
@keyframes rp{0%{opacity:.5;transform:translate(-50%,-50%) scale(.85)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.15)}}

/* PLAYING */
#s-play{justify-content:flex-start;padding-top:10px;gap:14px;width:100%}
.score-bar{display:flex;width:100%;height:42px;border-radius:50px;overflow:hidden;background:var(--surf2);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.sb-seg{display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:rgba(255,255,255,.95);transition:width .5s cubic-bezier(.4,0,.2,1);min-width:5%;padding:0 8px;white-space:nowrap;overflow:hidden}
.timer-row{width:100%;display:flex;align-items:center;gap:12px}
.timer-num{font-family:'Outfit',sans-serif;font-size:30px;font-weight:800;min-width:46px;text-align:center;transition:color .3s}
.timer-num.warn{color:var(--danger);animation:tp .5s infinite alternate}
@keyframes tp{to{transform:scale(1.12)}}
.timer-track{flex:1;height:7px;background:var(--surf2);border-radius:8px;overflow:hidden}
.timer-fill{height:100%;background:linear-gradient(90deg,var(--accent),#A78BFA,var(--accent2));border-radius:8px}
.q-card{width:100%;background:var(--surf);border:1px solid var(--border2);border-radius:var(--r);padding:22px 20px}
.q-meta{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px}
.q-text{font-family:'Outfit',sans-serif;font-size:20px;font-weight:700;line-height:1.4;margin-bottom:20px}
.opts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.opt{display:flex;align-items:center;gap:10px;padding:14px 12px;background:var(--surf2);border:2px solid transparent;border-radius:14px;cursor:pointer;font-size:14px;font-weight:500;text-align:left;color:var(--text);transition:all .18s;position:relative;overflow:hidden}
.opt::before{content:'';position:absolute;inset:0;background:var(--oc);opacity:0;transition:opacity .18s}
.opt:hover:not(.dis):not(.pending){border-color:var(--oc);transform:translateY(-2px)}
.opt:hover:not(.dis):not(.pending)::before{opacity:.1}
.opt.pending{border-color:var(--oc);border-style:dashed;background:rgba(91,110,245,.05)}
.opt.pending .opt-ltr{opacity:.7}
.opt.correct{border-color:var(--success) !important;background:rgba(67,217,142,.13) !important}
.opt.correct .opt-ltr{background:var(--success) !important}
.opt.wrong-sel{border-color:var(--danger) !important;background:rgba(240,96,96,.1) !important}
.opt.wrong-sel .opt-ltr{background:var(--danger) !important}
.opt.dis{cursor:not-allowed}
.opt-ltr{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:8px;font-weight:800;font-size:12px;background:var(--oc);color:#fff;flex-shrink:0;position:relative;z-index:1;transition:background .3s}
.opt-txt{position:relative;z-index:1;line-height:1.3}
.ans-feed{width:100%;display:flex;flex-wrap:wrap;gap:6px;min-height:24px}
.feed-chip{padding:4px 10px;border-radius:50px;font-size:11px;font-weight:600;animation:chipIn .2s ease;background:rgba(91,110,245,.1);border:1px solid rgba(91,110,245,.2);color:var(--muted)}
.feed-chip.correct{background:rgba(67,217,142,.1);border-color:rgba(67,217,142,.3);color:var(--success)}
.feed-chip.wrong{background:rgba(240,96,96,.1);border-color:rgba(240,96,96,.3);color:var(--danger)}
.pts-pop{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Outfit',sans-serif;font-size:58px;font-weight:900;color:#fff;text-shadow:0 0 40px var(--accent),0 4px 20px rgba(0,0,0,.5);pointer-events:none;animation:pp 1.2s ease-out forwards;z-index:100}
@keyframes pp{0%{opacity:0;transform:translate(-50%,-20%)}20%{opacity:1;transform:translate(-50%,-55%)}80%{opacity:1;transform:translate(-50%,-75%)}100%{opacity:0;transform:translate(-50%,-95%)}}

/* FINISHED */
#s-fin{justify-content:flex-start;padding-top:20px;gap:16px;width:100%}
.win-card{width:100%;background:var(--surf);border:1px solid var(--border2);border-radius:var(--r);padding:32px 22px 24px;text-align:center}
.win-txt{font-family:'Outfit',sans-serif;font-size:30px;font-weight:900;margin-bottom:22px;background:linear-gradient(135deg,#FFD54F,#FF6D00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.fin-scores{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:20px}
.fin-sc{flex:1;min-width:90px;background:var(--surf2);border:2px solid var(--tc,transparent);border-radius:16px;padding:18px 12px}
.fin-sc.winner{background:linear-gradient(135deg,rgba(255,213,79,.07),rgba(255,109,0,.07));box-shadow:0 4px 24px rgba(255,213,79,.12)}
.fin-emoji{font-size:34px;margin-bottom:6px}
.fin-name{font-size:12px;color:var(--muted);margin-bottom:8px}
.fin-pts{font-family:'Outfit',sans-serif;font-size:28px;font-weight:900}
.fin-btns{display:flex;gap:10px;width:100%;flex-wrap:wrap}
.fin-btn{flex:1;min-width:120px;padding:14px 10px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;border-radius:14px;cursor:pointer;transition:all .2s;border:none;display:flex;align-items:center;justify-content:center;gap:6px}
.fin-btn.stats-btn{background:var(--surf2);border:1px solid var(--border2);color:var(--text)}
.fin-btn.stats-btn:hover{background:var(--surf3);border-color:var(--accent);color:var(--accent)}
.fin-btn.export-btn{background:rgba(67,217,142,.12);border:1px solid rgba(67,217,142,.35);color:var(--success)}
.fin-btn.export-btn:hover{background:rgba(67,217,142,.2);transform:translateY(-1px)}
.fin-btn.back-btn{background:linear-gradient(135deg,var(--accent),#8B5CF6);color:#fff;box-shadow:0 4px 16px rgba(91,110,245,.3)}
.fin-btn.back-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(91,110,245,.4)}
.lb-card{width:100%;background:var(--surf);border:1px solid var(--border2);border-radius:var(--r);padding:22px}
.lb-card h2{font-family:'Outfit',sans-serif;font-size:18px;font-weight:700;margin-bottom:14px}
.lb-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surf2);border-radius:12px;margin-bottom:8px;border-left:3px solid var(--tc,var(--accent));animation:chipIn .3s ease}
.lb-rank{font-size:20px;min-width:28px}
.lb-info{flex:1}
.lb-name{display:block;font-weight:600;font-size:15px}
.lb-team{display:block;font-size:12px;color:var(--muted);margin-top:1px}
.lb-score{font-family:'Outfit',sans-serif;font-weight:800;font-size:16px;color:var(--gold)}

/* TOAST */
.toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-90px);background:var(--surf2);border:1px solid var(--border2);border-radius:50px;padding:10px 22px;font-size:13px;font-weight:600;transition:transform .35s cubic-bezier(.34,1.56,.64,1);z-index:999;white-space:nowrap;backdrop-filter:blur(12px);box-shadow:0 8px 24px rgba(0,0,0,.35)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.ok{border-color:rgba(67,217,142,.4);color:var(--success)}
.toast.err{border-color:rgba(240,96,96,.4);color:var(--danger)}
.toast.inf{border-color:rgba(91,110,245,.4);color:#a0aaff}

@media(max-width:380px){
    .opts{grid-template-columns:1fr}
    .cd-num{font-size:90px}
    .q-text{font-size:17px}
    .team-sel-grid{grid-template-columns:repeat(2,1fr)}
    .fin-btns{flex-direction:column}
}
    </style>
</head>
<body>
<div class="wrap">

    <div id="s-loading" class="state active">
        <div class="spinner"></div>
        <p class="load-txt" data-i18n="loading">Loading room...</p>
    </div>

    <div id="s-error" class="state">
        <div class="err-box">
            <div class="err-icon">‚ö†Ô∏è</div>
            <h2 data-i18n="connError">Connection Error</h2>
            <p id="err-msg">Something went wrong.</p>
            <div class="err-hint" id="err-hint" style="display:none" data-i18n="roomEndedHint"></div>
        </div>
    </div>

    <div id="s-lobby" class="state">
        <div class="lobby-head">
            <div class="quiz-badge">‚öîÔ∏è QUIZ BATTLE</div>
            <h1 id="quiz-title">Quiz Battle</h1>
            <div class="quiz-meta-row">
                <div class="quiz-meta-pill">üìù <span id="q-count">‚Äî</span> <span data-i18n="questions">questions</span></div>
                <div class="quiz-meta-pill">‚è± <span id="q-time">‚Äî</span>s / <span data-i18n="question">question</span></div>
            </div>
            <div class="room-badge">
                <span class="room-label" data-i18n="room">Room</span>
                <strong id="room-code">‚Äî</strong>
            </div>
        </div>
        <div id="area-sel" style="width:100%">
            <div class="sec-head">
                <span class="sec-title" data-i18n="pickTeam">Pick your team</span>
                <span class="count-badge"><span id="pc1">0</span> <span data-i18n="inRoom">in room</span></span>
            </div>
            <div id="sel-grid" class="team-sel-grid"></div>
            <button class="add-team-btn" onclick="openAddTeam()" id="add-btn-top">Ôºã &nbsp;<span data-i18n="createTeam">Create New Team</span></button>
        </div>
        <div id="area-lobby" style="display:none;width:100%">
            <div class="sec-head">
                <span class="sec-title" data-i18n="battleLobby">Battle Lobby</span>
                <span class="count-badge"><span id="pc2">0</span> <span data-i18n="players">players</span></span>
            </div>
            <div id="teams-grid" class="teams-grid"></div>
            <div class="switch-team-wrap">
                <button class="switch-team-btn" onclick="switchTeam()">üîÑ <span data-i18n="switchTeam">Switch Team</span></button>
            </div>
            <button class="add-team-btn" onclick="openAddTeam()">Ôºã &nbsp;<span data-i18n="createTeam">Create New Team</span></button>
            <button class="start-btn" id="start-btn" onclick="startGame()" disabled data-i18n="waitingPlayers">Waiting for players...</button>
        </div>
    </div>

    <div id="s-cd" class="state">
        <div class="cd-wrap">
            <div class="cd-label" data-i18n="getReady">Get Ready!</div>
            <div class="cd-num" id="cd-num">3</div>
            <div class="cd-rings">
                <div class="ring r1"></div><div class="ring r2"></div><div class="ring r3"></div>
            </div>
        </div>
    </div>

    <div id="s-play" class="state">
        <div class="score-bar" id="score-bar"></div>
        <div class="timer-row">
            <div class="timer-num" id="timer">30</div>
            <div class="timer-track"><div class="timer-fill" id="timer-fill"></div></div>
        </div>
        <div class="q-card">
            <div class="q-meta" id="q-meta">Question 1 / 5</div>
            <h2 class="q-text" id="q-text">Loading...</h2>
            <div class="opts" id="opts"></div>
        </div>
        <div class="ans-feed" id="ans-feed"></div>
    </div>

    <div id="s-fin" class="state">
        <div class="win-card">
            <h1 class="win-txt" id="win-txt">üèÜ Results</h1>
            <div class="fin-scores" id="fin-scores"></div>
            <div class="fin-btns">
                <button class="fin-btn stats-btn" onclick="openStats()">üìä <span data-i18n="stats">Stats</span></button>
                <button class="fin-btn export-btn" onclick="exportResults()" id="export-btn">üìÑ <span data-i18n="exportDocx">Export DOCX</span></button>
                <button class="fin-btn back-btn" onclick="goBack()">üè† <span data-i18n="close">Close</span></button>
            </div>
        </div>
        <div class="lb-card">
            <h2>üèÜ <span data-i18n="leaderboard">Leaderboard</span></h2>
            <div id="lb-list"></div>
        </div>
    </div>
</div>

<!-- ADD TEAM MODAL -->
<div id="modal-add" class="modal-ov" onclick="bgClose(event,'modal-add')">
    <div class="modal-box">
        <div class="modal-hd">
            <h3 data-i18n="createNewTeam">Create New Team</h3>
            <button class="modal-x" onclick="closeM('modal-add')">‚úï</button>
        </div>
        <div class="modal-bd">
            <div class="m-preview" id="m-preview">üü¢</div>
            <p class="m-hint" data-i18n="teamHint">Emoji & color auto-assigned ‚Äî enter a custom name below</p>
            <input type="text" id="m-input" class="m-input" data-i18n-placeholder="teamNamePlaceholder" placeholder="Team name (optional)..." maxlength="20" autocomplete="off">
        </div>
        <div class="m-actions">
            <button class="m-cancel" onclick="closeM('modal-add')" data-i18n="cancel">Cancel</button>
            <button class="m-confirm" onclick="confirmAdd()" data-i18n="createTeamBtn">Create Team ‚ö°</button>
        </div>
    </div>
</div>

<!-- SWITCH TEAM MODAL -->
<div id="modal-switch" class="modal-ov" onclick="bgClose(event,'modal-switch')">
    <div class="modal-box">
        <div class="modal-hd">
            <h3 data-i18n="switchTeamTitle">Switch Team</h3>
            <button class="modal-x" onclick="closeM('modal-switch')">‚úï</button>
        </div>
        <div class="modal-bd" id="switch-grid" style="padding-bottom:8px"></div>
    </div>
</div>

<!-- STATS MODAL -->
<div id="modal-stats" class="modal-ov" onclick="bgClose(event,'modal-stats')">
    <div class="modal-box">
        <div class="modal-hd">
            <h3>üìä <span data-i18n="detailedStats">Detailed Stats</span></h3>
            <button class="modal-x" onclick="closeM('modal-stats')">‚úï</button>
        </div>
        <div class="stats-scroll" id="stats-body"></div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
// ‚îÄ‚îÄ Bot deep link ‚îÄ‚îÄ
const BOT_USERNAME = new URLSearchParams(location.search).get("bot") || "SimpleLearnUz_bot";
const BOT_URL = `https://t.me/${BOT_USERNAME}`;

// ‚îÄ‚îÄ i18n ‚îÄ‚îÄ
const I18N = {
    en: {
        loading: "Loading room...",
        connError: "Connection Error",
        roomEndedHint: "This room may have expired or ended. Go back to the bot and create a new battle room!",
        roomNotFound: "Room not found or has already ended.",
        roomFinished: "This battle has already ended. Create a new room in the bot to play again!",
        questions: "questions",
        question: "question",
        room: "Room",
        pickTeam: "Pick your team",
        inRoom: "in room",
        createTeam: "Create New Team",
        battleLobby: "Battle Lobby",
        players: "players",
        switchTeam: "Switch Team",
        switchTeamTitle: "Switch Team",
        waitingPlayers: "Waiting for players...",
        startBattle: "‚öîÔ∏è Start Battle!",
        waitingMin: "Waiting for players... ({n}/2 min)",
        getReady: "Get Ready!",
        stats: "Stats",
        exportDocx: "Export DOCX",
        close: "Close",
        createNewTeam: "Create New Team",
        teamHint: "Emoji & color auto-assigned ‚Äî enter a custom name below",
        teamNamePlaceholder: "Team name (optional)...",
        cancel: "Cancel",
        createTeamBtn: "Create Team ‚ö°",
        detailedStats: "Detailed Stats",
        leaderboard: "Leaderboard",
        noStats: "No stats recorded yet.",
        join: "Join",
        you: "You",
        correctLabel: "‚úì Correct",
        wrongLabel: "‚úó Wrong",
        skipped: "‚è≠ Skipped",
        exporting: "‚è≥ Exporting...",
        exported: "DOCX saved! ‚úÖ",
        exportFail: "Export failed",
        correct: "‚úÖ Correct! +{pts} pts",
        wrong: "‚ùå Wrong answer!",
        creatingTeam: "Creating team...",
        maxTeams: "Maximum 6 teams reached",
        joined: "Joined {emoji} {name}!",
        switched: "Switched to {emoji} {name}!",
        questionOf: "Question {n} / {total}",
        winner: "{emoji} {name} Wins!",
        results: "üèÜ Results!",
        teamScore: "Team Scores",
        questionBreakdown: "Question Breakdown",
        correctAns: "Correct Answer",
    },
    ru: {
        loading: "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç—ã...",
        connError: "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è",
        roomEndedHint: "–ö–æ–º–Ω–∞—Ç–∞ –º–æ–≥–ª–∞ –∏—Å—Ç–µ—á—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –±–æ—Ç –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –±–∏—Ç–≤—ã!",
        roomNotFound: "–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.",
        roomFinished: "–≠—Ç–∞ –±–∏—Ç–≤–∞ —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É –≤ –±–æ—Ç–µ, —á—Ç–æ–±—ã —Å—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞!",
        questions: "–≤–æ–ø—Ä–æ—Å–æ–≤",
        question: "–≤–æ–ø—Ä–æ—Å",
        room: "–ö–æ–º–Ω–∞—Ç–∞",
        pickTeam: "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É",
        inRoom: "–≤ –∫–æ–º–Ω–∞—Ç–µ",
        createTeam: "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É",
        battleLobby: "–õ–æ–±–±–∏",
        players: "–∏–≥—Ä–æ–∫–æ–≤",
        switchTeam: "–°–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É",
        switchTeamTitle: "–°–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É",
        waitingPlayers: "–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...",
        startBattle: "‚öîÔ∏è –ù–∞—á–∞—Ç—å –±–∏—Ç–≤—É!",
        waitingMin: "–û–∂–∏–¥–∞–Ω–∏–µ... ({n}/2 –º–∏–Ω)",
        getReady: "–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å!",
        stats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        exportDocx: "–≠–∫—Å–ø–æ—Ä—Ç DOCX",
        close: "–ó–∞–∫—Ä—ã—Ç—å",
        createNewTeam: "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É",
        teamHint: "–≠–º–æ–¥–∑–∏ –∏ —Ü–≤–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∏–∂–µ",
        teamNamePlaceholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)...",
        cancel: "–û—Ç–º–µ–Ω–∞",
        createTeamBtn: "–°–æ–∑–¥–∞—Ç—å ‚ö°",
        detailedStats: "–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        leaderboard: "–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤",
        noStats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.",
        join: "–í—Å—Ç—É–ø–∏—Ç—å",
        you: "–í—ã",
        correctLabel: "‚úì –í–µ—Ä–Ω–æ",
        wrongLabel: "‚úó –ù–µ–≤–µ—Ä–Ω–æ",
        skipped: "‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω–æ",
        exporting: "‚è≥ –≠–∫—Å–ø–æ—Ä—Ç...",
        exported: "DOCX —Å–æ—Ö—Ä–∞–Ω—ë–Ω! ‚úÖ",
        exportFail: "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞",
        correct: "‚úÖ –í–µ—Ä–Ω–æ! +{pts} –æ—á–∫–æ–≤",
        wrong: "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç!",
        creatingTeam: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã...",
        maxTeams: "–ú–∞–∫—Å–∏–º—É–º 6 –∫–æ–º–∞–Ω–¥",
        joined: "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ {emoji} {name}!",
        switched: "–ü–µ—Ä–µ—à–ª–∏ –≤ {emoji} {name}!",
        questionOf: "–í–æ–ø—Ä–æ—Å {n} / {total}",
        winner: "{emoji} {name} –ø–æ–±–µ–∂–¥–∞–µ—Ç!",
        results: "üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã!",
        teamScore: "–°—á—ë—Ç –∫–æ–º–∞–Ω–¥",
        questionBreakdown: "–†–∞–∑–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤",
        correctAns: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç",
    },
    uz: {
        loading: "Xona yuklanmoqda...",
        connError: "Ulanish xatosi",
        roomEndedHint: "Xona muddati tugagan yoki yakunlangan bo'lishi mumkin. Botga qayting va yangi jang xonasi yarating!",
        roomNotFound: "Xona topilmadi yoki allaqachon yakunlangan.",
        roomFinished: "Bu jang allaqachon tugadi. Yana o'ynash uchun botda yangi xona yarating!",
        questions: "savol",
        question: "savol",
        room: "Xona",
        pickTeam: "Jamoangizni tanlang",
        inRoom: "xonada",
        createTeam: "Yangi jamoa yaratish",
        battleLobby: "Jang Lobbisi",
        players: "o'yinchi",
        switchTeam: "Jamoani almashtirish",
        switchTeamTitle: "Jamoani almashtirish",
        waitingPlayers: "O'yinchilar kutilmoqda...",
        startBattle: "‚öîÔ∏è Jangni boshlash!",
        waitingMin: "Kutilmoqda... ({n}/2 min)",
        getReady: "Tayyor bo'ling!",
        stats: "Statistika",
        exportDocx: "DOCX yuklab olish",
        close: "Yopish",
        createNewTeam: "Yangi jamoa yaratish",
        teamHint: "Emoji va rang avtomatik tayinlanadi ‚Äî quyida nom kiriting",
        teamNamePlaceholder: "Jamoa nomi (ixtiyoriy)...",
        cancel: "Bekor qilish",
        createTeamBtn: "Jamoa yaratish ‚ö°",
        detailedStats: "Batafsil statistika",
        leaderboard: "Reyting",
        noStats: "Statistika yo'q.",
        join: "Qo'shilish",
        you: "Siz",
        correctLabel: "‚úì To'g'ri",
        wrongLabel: "‚úó Noto'g'ri",
        skipped: "‚è≠ O'tkazildi",
        exporting: "‚è≥ Eksport...",
        exported: "DOCX saqlandi! ‚úÖ",
        exportFail: "Eksport muvaffaqiyatsiz",
        correct: "‚úÖ To'g'ri! +{pts} ball",
        wrong: "‚ùå Noto'g'ri javob!",
        creatingTeam: "Jamoa yaratilmoqda...",
        maxTeams: "Maksimum 6 ta jamoa",
        joined: "{emoji} {name} jamoasiga qo'shildingiz!",
        switched: "{emoji} {name} jamoasiga o'tdingiz!",
        questionOf: "Savol {n} / {total}",
        winner: "{emoji} {name} g'alaba qildi!",
        results: "üèÜ Natijalar!",
        teamScore: "Jamoa ballari",
        questionBreakdown: "Savol tahlili",
        correctAns: "To'g'ri javob",
    }
};

let LANG = "en";
function t(key, vars = {}) {
    let s = (I18N[LANG] || I18N.en)[key] || (I18N.en[key] || key);
    for (const [k, v] of Object.entries(vars)) s = s.replace(`{${k}}`, v);
    return s;
}
function applyI18n() {
    document.querySelectorAll("[data-i18n]").forEach(el => {
        el.textContent = t(el.dataset.i18n);
    });
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        el.placeholder = t(el.dataset.i18nPlaceholder);
    });
}

const TEMPLATES = [
    {color:"#FF6B6B",emoji:"üî¥",name:"Red"},
    {color:"#4ECDC4",emoji:"üîµ",name:"Blue"},
    {color:"#FFE66D",emoji:"üü°",name:"Yellow"},
    {color:"#A29BFE",emoji:"üü£",name:"Purple"},
    {color:"#55EFC4",emoji:"üü¢",name:"Green"},
    {color:"#FD79A8",emoji:"ü©∑",name:"Pink"},
];
const OPT_COLORS = ["#FF6B6B","#4ECDC4","#FFE66D","#A29BFE"];
const LETTERS    = ["A","B","C","D"];

const tg = window.Telegram?.WebApp;
tg?.ready(); tg?.expand();

// Detect language
(function detectLang() {
    const userLang = tg?.initDataUnsafe?.user?.language_code || navigator.language || "en";
    if (userLang.startsWith("uz")) LANG = "uz";
    else if (userLang.startsWith("ru")) LANG = "ru";
    else LANG = "en";
})();

const S = {
    roomId:null, ws:null,
    userId:null, firstName:null, username:null,
    myTeam:null, teams:{}, teamScores:{},
    curQ:null, timerInt:null, answered:false,
    myAnswerIdx:null,
    pendingAnswers: [],
    qLog:[],
    finData:null,
    lastCdVal:null,
    quizData:null,
    // FIX 1: track all players' cumulative scores by userId for accurate score bar
    playerScores: {},
};
const API = window.location.origin;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
    applyI18n();
    const p = new URLSearchParams(location.search);
    S.roomId = p.get("room");
    if(!S.roomId){ showErr(t("roomNotFound")); return; }

    if(tg?.initDataUnsafe?.user){
        const u = tg.initDataUnsafe.user;
        S.userId = u.id; S.firstName = u.first_name; S.username = u.username||"";
    } else {
        S.userId = Math.floor(Math.random()*1e6);
        S.firstName = "Player"+S.userId; S.username = "";
    }

    try {
        const r = await fetch(`${API}/api/room/${S.roomId}`);
        const d = await r.json();

        if(d.error){ showErr(t("roomNotFound"), true); return; }

        document.getElementById("quiz-title").textContent = d.quiz_title || "üéÆ Quiz Battle";
        document.getElementById("room-code").textContent  = S.roomId;
        document.getElementById("q-count").textContent = d.total_questions || "‚Äî";

        if(d.state === "finished"){
            showErr(t("roomFinished"), true);
            return;
        }

        connectWS();
    } catch(e){
        showErr(t("roomNotFound"), true);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WEBSOCKET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectWS(){
    const proto = location.protocol === "https:" ? "wss:" : "ws:";
    S.ws = new WebSocket(`${proto}//${location.host}/ws/${S.roomId}`);
    S.ws.onmessage = e => handleMsg(JSON.parse(e.data));
    S.ws.onerror   = () => showErr(t("connError"));
    S.ws.onclose   = () => {
        if(el("s-play").classList.contains("active")) showErr(t("connError"));
    };
}
function send(d){ if(S.ws?.readyState === WebSocket.OPEN) S.ws.send(JSON.stringify(d)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE HANDLER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleMsg(d){
    switch(d.type){
        case "room_state":
            if(d.teams) S.teams = d.teams;
            if(d.quiz_time) { document.getElementById("q-time").textContent = d.quiz_time; }
            renderTeams(); showState("s-lobby"); break;

        case "teams_updated":
        case "player_joined":
            if(d.teams) S.teams = d.teams;
            renderTeams(); updateStart(); break;

        case "player_left":
            if(d.teams){ S.teams = d.teams; renderTeams(); } break;

        case "countdown":
            if(d.seconds === S.lastCdVal) break;
            S.lastCdVal = d.seconds;
            showState("s-cd");
            animCD(d.seconds);
            break;

        case "question":
            S.lastCdVal = null;
            showQ(d); break;

        case "answer_submitted":
            onAnswerSubmitted(d); break;

        case "question_ended":
            revealAnswers(d); break;

        case "quiz_finished":
            revealAnswers(null);
            setTimeout(() => showFin(d), 900);
            break;

        case "error":
            toast(d.message, "err"); break;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TEAM RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTeams(){
    const ids = Object.keys(S.teams);
    let total = 0;
    for(const t2 of Object.values(S.teams)) total += (t2.players||[]).length;
    setText("pc1", total); setText("pc2", total);

    // Selection grid
    const sg = el("sel-grid"); sg.innerHTML = "";
    for(const [tid, team] of Object.entries(S.teams)){
        const pl  = team.players || [];
        const cnt = pl.length;
        const playerNames = pl.length > 0 ? pl.map(p => p.first_name).join(", ") : "";
        const c = document.createElement("div");
        c.className = "tsc"; c.style.setProperty("--tc", team.color);
        c.innerHTML = `<div class="tsc-glow"></div>
            <div class="tsc-emoji">${team.emoji}</div>
            <div class="tsc-name">${team.name}</div>
            <div class="tsc-cnt">${cnt} ${t('players')}</div>
            <div class="tsc-players">${playerNames}</div>
            <button class="tsc-btn" onclick="joinTeam('${tid}')">${t('join')}</button>`;
        sg.appendChild(c);
    }

    // Lobby teams grid
    const tg2 = el("teams-grid"); tg2.innerHTML = "";
    for(const [tid, team] of Object.entries(S.teams)){
        const pl = team.players || [];
        const playerChips = pl.length === 0
            ? `<div class="no-p">‚Äî</div>`
            : pl.map(p => `<div class="p-chip ${p.user_id===S.userId?"me":""}">
                <div class="p-av">${(p.first_name||"?")[0].toUpperCase()}</div>
                <span>${p.first_name}${p.user_id===S.userId?` <em>(${t('you')})</em>`:""}</span>
              </div>`).join("");
        const c = document.createElement("div");
        c.className = "team-card"; c.style.setProperty("--tc", team.color);
        c.innerHTML = `<div class="tc-top">
            <span class="tc-emoji">${team.emoji}</span>
            <div class="tc-info">
                <span class="tc-name">${team.name}</span>
                <span class="tc-count">${pl.length} ${t('players')}</span>
            </div></div>
            <div class="tc-players">${playerChips}</div>`;
        tg2.appendChild(c);
    }

    const ab = el("add-btn-top");
    if(ab) ab.style.display = ids.length >= 6 ? "none" : "flex";
}

function joinTeam(tid){
    S.myTeam = tid;
    const team = S.teams[tid];
    send({type:"join", user_id:S.userId, username:S.username, first_name:S.firstName, team:tid});
    el("area-sel").style.display = "none";
    el("area-lobby").style.display = "block";
    toast(t("joined", {emoji: team.emoji, name: team.name}), "ok");
}

function switchTeam(){
    const sg = el("switch-grid"); sg.innerHTML = "";
    for(const [tid, team] of Object.entries(S.teams)){
        if(tid === S.myTeam) continue;
        const c = document.createElement("div");
        c.className = "tsc"; c.style.setProperty("--tc", team.color);
        c.style.cssText += ";margin-bottom:0;border-radius:14px";
        const pl = team.players || [];
        c.innerHTML = `<div class="tsc-glow"></div>
            <div class="tsc-emoji">${team.emoji}</div>
            <div class="tsc-name">${team.name}</div>
            <div class="tsc-cnt">${pl.length} ${t('players')}</div>
            <button class="tsc-btn" onclick="doSwitch('${tid}')">${t('switchTeam')}</button>`;
        sg.appendChild(c);
    }
    openM("modal-switch");
}

function doSwitch(tid){
    S.myTeam = tid;
    const team = S.teams[tid];
    send({type:"join", user_id:S.userId, username:S.username, first_name:S.firstName, team:tid});
    closeM("modal-switch");
    toast(t("switched", {emoji: team.emoji, name: team.name}), "ok");
}

function updateStart(){
    const btn = el("start-btn"); if(!btn) return;
    let total = 0, withP = 0;
    for(const t2 of Object.values(S.teams)){
        const c = (t2.players||[]).length;
        if(c > 0) withP++;
        total += c;
    }
    const ok = total >= 2 && withP >= 2;
    btn.disabled = !ok;
    btn.textContent = ok ? t("startBattle") : t("waitingMin", {n: total});
}

function startGame(){ send({type:"start_game"}); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD TEAM MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddTeam(){
    const currentCount  = Object.keys(S.teams).length;
    const templateIdx   = currentCount % TEMPLATES.length;
    const preview       = TEMPLATES[templateIdx];
    el("m-preview").textContent = preview.emoji;
    el("m-input").value = "";
    openM("modal-add");
    setTimeout(() => el("m-input").focus(), 350);
}

function confirmAdd(){
    const name = el("m-input").value.trim();
    send({type:"add_team", custom_name: name || null});
    closeM("modal-add");
    toast(t("creatingTeam"), "inf");
}

el("m-input").addEventListener("keydown", e => { if(e.key === "Enter") confirmAdd(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COUNTDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function animCD(n){
    const e2 = el("cd-num");
    e2.textContent = n <= 0 ? "GO!" : String(n);
    e2.style.animation = "none";
    e2.offsetHeight;
    e2.style.animation = "cdPulse .9s ease-out forwards";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUESTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showQ(d){
    showState("s-play");
    S.curQ = d; S.answered = false; S.myAnswerIdx = null; S.pendingAnswers = [];
    el("ans-feed").innerHTML = "";

    // Update quiz time pill
    if(d.time_limit) document.getElementById("q-time").textContent = d.time_limit;

    // Init log for this question
    while(S.qLog.length <= d.question_idx){
        S.qLog.push({ text:"", options:[], correct_idx:-1, answers:{} });
    }
    S.qLog[d.question_idx].text    = d.question_text;
    S.qLog[d.question_idx].options = d.options;

    setText("q-meta", t("questionOf", {n: d.question_idx+1, total: d.total_questions}));
    setText("q-text", d.question_text);

    const optsEl = el("opts"); optsEl.innerHTML = "";
    d.options.forEach((opt, i) => {
        const b = document.createElement("button");
        b.className = "opt"; b.id = `opt-${i}`;
        b.style.setProperty("--oc", OPT_COLORS[i % OPT_COLORS.length]);
        b.innerHTML = `<span class="opt-ltr">${LETTERS[i]}</span><span class="opt-txt">${opt}</span>`;
        b.onclick = () => submitAns(i, b);
        optsEl.appendChild(b);
    });

    updateScoreBar();
    startTimer(d.time_limit);
}

function submitAns(idx, btn){
    if(S.answered) return;
    S.answered = true; S.myAnswerIdx = idx;
    document.querySelectorAll(".opt").forEach(o => o.classList.add("dis"));
    btn.classList.remove("dis");
    btn.classList.add("pending");
    send({type:"answer", question_idx:S.curQ.question_idx, answer:idx});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIX 1: Track answers from ALL players
//  The server sends answer_submitted for every player.
//  We buffer them and reveal at question end.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onAnswerSubmitted(d){
    const qi = S.curQ?.question_idx ?? 0;

    // Find team color for this player ‚Äî search through S.teams
    let teamColor = "#aaa";
    let playerTeamId = null;
    for(const [tid, team] of Object.entries(S.teams)){
        if(team.players?.find(p => p.user_id === d.user_id)){
            teamColor = team.color;
            playerTeamId = tid;
            break;
        }
    }

    // Store answer in qLog for stats (use server's points field)
    if(S.qLog[qi]){
        S.qLog[qi].answers[d.user_id] = {
            name: d.first_name,
            correct: d.is_correct,
            pts: d.points || 0,   // server sends "points"
            teamColor,
        };
    }

    // Buffer answer for reveal
    S.pendingAnswers.push({ ...d, _teamId: playerTeamId });

    // Show neutral "answered" chip (no color reveal yet)
    const feed = el("ans-feed");
    // Avoid duplicate chips if same user somehow double-submits
    if(!document.getElementById(`chip-${d.user_id}`)){
        const chip = document.createElement("span");
        chip.className = "feed-chip";
        chip.id = `chip-${d.user_id}`;
        chip.textContent = `${d.first_name} ‚úì`;
        feed.appendChild(chip);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REVEAL ANSWERS (after timer ends)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function revealAnswers(data){
    clearInterval(S.timerInt);
    document.querySelectorAll(".opt").forEach(o => {
        o.classList.remove("pending");
        o.classList.add("dis");
    });

    let myResult = null;

    // FIX 1: Update cumulative scores for ALL pending answers from ALL players
    for(const d of S.pendingAnswers){
        if(d.is_correct){
            // FIX 1: Accumulate per-player score, then recompute team totals
            S.playerScores[d.user_id] = (S.playerScores[d.user_id] || 0) + (d.points || 0);

            // Also update teamScores by team
            const tid = d._teamId;
            if(tid){
                S.teamScores[tid] = (S.teamScores[tid] || 0) + (d.points || 0);
            } else {
                // Fallback: search teams if _teamId wasn't set
                for(const [teamId, team] of Object.entries(S.teams)){
                    if(team.players?.find(p => p.user_id === d.user_id)){
                        S.teamScores[teamId] = (S.teamScores[teamId] || 0) + (d.points || 0);
                        break;
                    }
                }
            }
        }

        if(d.user_id === S.userId) myResult = d;

        // Reveal chips to correct/wrong
        const chip = document.getElementById(`chip-${d.user_id}`);
        if(chip){
            chip.className = `feed-chip ${d.is_correct ? "correct" : "wrong"}`;
            chip.textContent = `${d.first_name} ${d.is_correct ? "‚úì" : "‚úó"}`;
        }
    }
    updateScoreBar();

    // FIX 2: Use d.points (not d.pts) ‚Äî server sends "points" field
    if(S.myAnswerIdx !== null){
        const myBtn = el(`opt-${S.myAnswerIdx}`);
        if(myResult){
            if(myResult.is_correct){
                myBtn?.classList.add("correct");
                // FIX 2: was myResult.pts ‚Äî should be myResult.points
                toast(t("correct", {pts: myResult.points}), "ok");
                ptsPopup(`+${myResult.points}`);
            } else {
                myBtn?.classList.add("wrong-sel");
                toast(t("wrong"), "err");
            }
        } else {
            myBtn?.classList.add("wrong-sel");
            toast(t("wrong"), "err");
        }
    }

    // Show correct answer from server data (if provided)
    if(data && data.correct_idx !== undefined){
        const qi = S.curQ?.question_idx ?? 0;
        if(S.qLog[qi]) S.qLog[qi].correct_idx = data.correct_idx;
        const correctBtn = el(`opt-${data.correct_idx}`);
        if(correctBtn && !correctBtn.classList.contains("correct")){
            correctBtn.classList.add("correct");
        }
    }
}

function ptsPopup(txt){
    const e2 = document.createElement("div");
    e2.className = "pts-pop"; e2.textContent = txt;
    el("s-play").appendChild(e2);
    setTimeout(() => e2.remove(), 1200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTimer(secs){
    clearInterval(S.timerInt);
    let rem = secs;
    const tNum = el("timer"), tFill = el("timer-fill");
    tNum.textContent = rem;
    tFill.style.transition = "none"; tFill.style.width = "100%"; tFill.offsetHeight;
    tFill.style.transition = `width ${secs}s linear`; tFill.style.width = "0%";
    S.timerInt = setInterval(() => {
        rem--;
        tNum.textContent = rem;
        tNum.className = "timer-num" + (rem <= 5 ? " warn" : "");
        if(rem <= 0){
            clearInterval(S.timerInt);
            revealAnswers(null);
        }
    }, 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCORE BAR
//  FIX 1: Uses S.teamScores which now correctly
//  accumulates points for ALL players on ALL teams
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateScoreBar(){
    const bar = el("score-bar"); bar.innerHTML = "";
    const ids  = Object.keys(S.teams);
    const total = ids.reduce((s, id) => s + (S.teamScores[id] || 0), 0) || 1;
    ids.forEach(id => {
        const team  = S.teams[id], score = S.teamScores[id] || 0;
        const pct   = Math.max(5, (score / total) * 100);
        const seg   = document.createElement("div");
        seg.className = "sb-seg"; seg.style.width = `${pct}%`; seg.style.background = team.color;
        seg.innerHTML = `<span>${team.emoji} ${score}</span>`;
        bar.appendChild(seg);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FINISHED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showFin(d){
    clearInterval(S.timerInt);
    S.finData = d;
    if(d.teams) S.teams = d.teams;
    showState("s-fin");

    const wt = S.teams[d.winner_team];
    setText("win-txt", wt ? t("winner", {emoji: wt.emoji, name: wt.name}) : t("results"));

    const fs = el("fin-scores"); fs.innerHTML = "";
    for(const [tid, score] of Object.entries(d.team_scores)){
        const team = S.teams[tid] || {emoji:"üè≥Ô∏è", name:tid, color:"#aaa"};
        const e2 = document.createElement("div");
        e2.className = "fin-sc" + (tid === d.winner_team ? " winner" : "");
        e2.style.setProperty("--tc", team.color);
        e2.innerHTML = `<div class="fin-emoji">${team.emoji}</div><div class="fin-name">${team.name}</div><div class="fin-pts">${score}</div>`;
        fs.appendChild(e2);
    }

    const ll = el("lb-list"); ll.innerHTML = "";
    const medals = ["ü•á","ü•à","ü•â"];
    d.leaderboard.forEach((p, i) => {
        const team = S.teams[p.team] || {color:"#aaa", emoji:"üè≥Ô∏è", name:p.team};
        const e2 = document.createElement("div");
        e2.className = "lb-item"; e2.style.setProperty("--tc", team.color);
        e2.innerHTML = `<span class="lb-rank">${medals[i] || "#"+(i+1)}</span>
            <div class="lb-info">
                <span class="lb-name">${p.first_name}</span>
                <span class="lb-team">${team.emoji} ${team.name}</span>
            </div>
            <span class="lb-score">${p.score} pts</span>`;
        ll.appendChild(e2);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT AS DOCX ‚Äî Zero dependency implementation
//  Builds a valid .docx (Office Open XML) file
//  entirely in-browser using JSZip-free raw ZIP
//  construction via the pako deflate alternative:
//  we use a simple uncompressed ZIP builder so
//  no external libraries are needed at all.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Minimal ZIP builder (no compression, store-only) ‚îÄ‚îÄ
// DOCX files are ZIP archives. We build one from scratch.
const DocxZip = {
    files: [],
    reset() { this.files = []; },
    add(name, content) {
        // content can be string or Uint8Array
        const data = typeof content === "string"
            ? new TextEncoder().encode(content)
            : content;
        this.files.push({ name, data });
    },
    build() {
        const enc = new TextEncoder();
        let offset = 0;
        const localHeaders = [];
        const centralDir = [];

        for (const file of this.files) {
            const nameBytes = enc.encode(file.name);
            const data = file.data;
            const crc = crc32(data);

            // Local file header
            const lh = new Uint8Array(30 + nameBytes.length);
            const lhv = new DataView(lh.buffer);
            lhv.setUint32(0, 0x04034b50, true);   // signature
            lhv.setUint16(4, 20, true);             // version needed
            lhv.setUint16(6, 0, true);              // flags
            lhv.setUint16(8, 0, true);              // compression: store
            lhv.setUint16(10, 0, true);             // mod time
            lhv.setUint16(12, 0, true);             // mod date
            lhv.setUint32(14, crc, true);           // crc32
            lhv.setUint32(18, data.length, true);   // compressed size
            lhv.setUint32(22, data.length, true);   // uncompressed size
            lhv.setUint16(26, nameBytes.length, true); // name length
            lhv.setUint16(28, 0, true);             // extra length
            lh.set(nameBytes, 30);

            localHeaders.push({ header: lh, data, nameBytes, crc, offset });

            // Central directory entry
            const cd = new Uint8Array(46 + nameBytes.length);
            const cdv = new DataView(cd.buffer);
            cdv.setUint32(0, 0x02014b50, true);    // signature
            cdv.setUint16(4, 20, true);             // version made
            cdv.setUint16(6, 20, true);             // version needed
            cdv.setUint16(8, 0, true);              // flags
            cdv.setUint16(10, 0, true);             // compression
            cdv.setUint16(12, 0, true);             // mod time
            cdv.setUint16(14, 0, true);             // mod date
            cdv.setUint32(16, crc, true);           // crc32
            cdv.setUint32(20, data.length, true);   // compressed size
            cdv.setUint32(24, data.length, true);   // uncompressed size
            cdv.setUint16(28, nameBytes.length, true);
            cdv.setUint16(30, 0, true);             // extra length
            cdv.setUint16(32, 0, true);             // comment length
            cdv.setUint16(34, 0, true);             // disk start
            cdv.setUint16(36, 0, true);             // internal attr
            cdv.setUint32(38, 0, true);             // external attr
            cdv.setUint32(42, offset, true);        // local header offset
            cd.set(nameBytes, 46);
            centralDir.push(cd);

            offset += lh.length + data.length;
        }

        const cdOffset = offset;
        const cdSize = centralDir.reduce((s, c) => s + c.length, 0);

        // End of central directory record
        const eocd = new Uint8Array(22);
        const eocdv = new DataView(eocd.buffer);
        eocdv.setUint32(0, 0x06054b50, true);
        eocdv.setUint16(4, 0, true);
        eocdv.setUint16(6, 0, true);
        eocdv.setUint16(8, this.files.length, true);
        eocdv.setUint16(10, this.files.length, true);
        eocdv.setUint32(12, cdSize, true);
        eocdv.setUint32(16, cdOffset, true);
        eocdv.setUint16(20, 0, true);

        const parts = [];
        for (const f of localHeaders) {
            parts.push(f.header);
            parts.push(f.data);
        }
        for (const c of centralDir) parts.push(c);
        parts.push(eocd);

        const total = parts.reduce((s, p) => s + p.length, 0);
        const out = new Uint8Array(total);
        let pos = 0;
        for (const p of parts) { out.set(p, pos); pos += p.length; }
        return out;
    }
};

function crc32(data) {
    let crc = 0xFFFFFFFF;
    if (!crc32.table) {
        crc32.table = new Uint32Array(256);
        for (let i = 0; i < 256; i++) {
            let c = i;
            for (let j = 0; j < 8; j++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
            crc32.table[i] = c;
        }
    }
    for (const byte of data) crc = crc32.table[(crc ^ byte) & 0xFF] ^ (crc >>> 8);
    return (crc ^ 0xFFFFFFFF) >>> 0;
}

// ‚îÄ‚îÄ XML helpers ‚îÄ‚îÄ
function xmlEsc(s) {
    return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        // strip non-XML-safe characters (emoji etc cause issues in some viewers)
        .replace(/[^\x09\x0A\x0D\x20-\x7E\u00A0-\uD7FF\uE000-\uFFFD]/g, "");
}

function wPara(runs, opts = {}) {
    const pPr = opts.style
        ? `<w:pPr><w:pStyle w:val="${opts.style}"/></w:pPr>`
        : (opts.spacing ? `<w:pPr><w:spacing w:before="${opts.spacing.before||0}" w:after="${opts.spacing.after||0}"/></w:pPr>` : "");
    return `<w:p>${pPr}${runs}</w:p>`;
}

function wRun(text, opts = {}) {
    const rPr = [
        opts.bold ? "<w:b/><w:bCs/>" : "",
        opts.size ? `<w:sz w:val="${opts.size}"/><w:szCs w:val="${opts.size}"/>` : "",
        opts.color ? `<w:color w:val="${opts.color}"/>` : "",
    ].join("");
    return `<w:r>${rPr ? `<w:rPr>${rPr}</w:rPr>` : ""}<w:t xml:space="preserve">${xmlEsc(text)}</w:t></w:r>`;
}

function wHeading(text, level, opts = {}) {
    return wPara(wRun(text, { bold: true, size: [0,40,32,26][level]||26, color: opts.color }), { style: `Heading${level}` });
}

function wTableRow(cells, isHeader = false) {
    const trPr = isHeader ? `<w:trPr><w:tblHeader/></w:trPr>` : "";
    return `<w:tr>${trPr}${cells.join("")}</w:tr>`;
}

function wTableCell(text, opts = {}) {
    const fill = opts.fill ? `<w:shd w:val="clear" w:color="auto" w:fill="${opts.fill}"/>` : "";
    const tcPr = `<w:tcPr>${fill}<w:tcW w:w="${opts.width || 3080}" w:type="dxa"/></w:tcPr>`;
    const run = wRun(text, { bold: opts.bold, color: opts.color, size: 20 });
    return `<w:tc>${tcPr}${wPara(run)}</w:tc>`;
}

function wTable(rows, colWidths) {
    const cols = colWidths.map(w => `<w:gridCol w:w="${w}"/>`).join("");
    const tblW = colWidths.reduce((a,b)=>a+b,0);
    const tblPr = `<w:tblPr><w:tblStyle w:val="TableGrid"/><w:tblW w:w="${tblW}" w:type="dxa"/><w:tblBorders>
        <w:top w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
        <w:left w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
        <w:bottom w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
        <w:right w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
        <w:insideH w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
        <w:insideV w:val="single" w:sz="4" w:space="0" w:color="CCCCCC"/>
    </w:tblBorders></w:tblPr><w:tblGrid>${cols}</w:tblGrid>`;
    return `<w:tbl>${tblPr}${rows.join("")}</w:tbl>`;
}

async function exportResults(){
    const btn = el("export-btn");
    btn.disabled = true;
    const origHTML = btn.innerHTML;
    btn.innerHTML = `‚è≥ ${t("exporting")}`;

    try {
        if(!S.finData){ toast(t("exportFail"), "err"); return; }

        const d = S.finData;
        const wt = S.teams[d.winner_team];
        const quizTitle = (el("quiz-title")?.textContent || "Quiz Battle").replace(/[^\x20-\x7E]/g, "");
        const medals = ["#1","#2","#3"];

        // ‚îÄ‚îÄ Build document body XML ‚îÄ‚îÄ
        const body = [];

        body.push(wHeading(`Quiz Battle Results`, 1));
        body.push(wPara(wRun(`Room: ${S.roomId}`, { color: "888888", size: 20 })));
        body.push(wPara(wRun(`Quiz: ${quizTitle}`, { size: 20 })));
        body.push(wPara(""));

        if(wt){
            body.push(wHeading(`WINNER: ${wt.name}`, 2, { color: "B8860B" }));
            body.push(wPara(""));
        }

        // Team scores table
        body.push(wHeading(t("teamScore"), 2));
        const scoreRows = [
            wTableRow([
                wTableCell("Team", { fill: "2D3561", bold: true, color: "FFFFFF", width: 5000 }),
                wTableCell("Score", { fill: "2D3561", bold: true, color: "FFFFFF", width: 4240 }),
            ], true),
            ...Object.entries(d.team_scores).map(([tid, score]) => {
                const team = S.teams[tid] || { name: tid };
                return wTableRow([
                    wTableCell(team.name, { width: 5000 }),
                    wTableCell(`${score} pts`, { width: 4240 }),
                ]);
            })
        ];
        body.push(wTable(scoreRows, [5000, 4240]));
        body.push(wPara(""));

        // Leaderboard
        body.push(wHeading(t("leaderboard"), 2));
        const lbRows = [
            wTableRow([
                wTableCell("Rank", { fill: "2D3561", bold: true, color: "FFFFFF", width: 1000 }),
                wTableCell("Player", { fill: "2D3561", bold: true, color: "FFFFFF", width: 3500 }),
                wTableCell("Team", { fill: "2D3561", bold: true, color: "FFFFFF", width: 2500 }),
                wTableCell("Score", { fill: "2D3561", bold: true, color: "FFFFFF", width: 2240 }),
            ], true),
            ...(d.leaderboard || []).map((p, i) => {
                const team = S.teams[p.team] || { name: p.team };
                return wTableRow([
                    wTableCell(medals[i] || `#${i+1}`, { width: 1000 }),
                    wTableCell(p.first_name, { bold: i === 0, width: 3500 }),
                    wTableCell(team.name, { width: 2500 }),
                    wTableCell(`${p.score} pts`, { bold: i === 0, width: 2240 }),
                ]);
            })
        ];
        body.push(wTable(lbRows, [1000, 3500, 2500, 2240]));
        body.push(wPara(""));

        // Question breakdown
        if(S.qLog.length){
            body.push(wHeading(t("questionBreakdown"), 2));

            S.qLog.forEach((q, qi) => {
                if(!q || !q.text) return;

                body.push(wHeading(`Q${qi+1}: ${q.text}`, 3));

                const opts = q.options || [];
                if(q.correct_idx >= 0 && opts[q.correct_idx]){
                    body.push(wPara(wRun(
                        `Correct Answer: ${LETTERS[q.correct_idx]}. ${opts[q.correct_idx]}`,
                        { color: "2E7D32", size: 20, bold: true }
                    )));
                }

                // Options list
                opts.forEach((opt, oi) => {
                    const isCorrect = oi === q.correct_idx;
                    body.push(wPara(
                        wRun(`  ${LETTERS[oi]}. ${opt}`, { size: 20, color: isCorrect ? "2E7D32" : "444444", bold: isCorrect })
                    ));
                });

                body.push(wPara(""));

                // Player answers table
                const answers = q.answers || {};
                const ansEntries = Object.entries(answers);
                if(ansEntries.length > 0){
                    const ansRows = [
                        wTableRow([
                            wTableCell("Player", { fill: "1C2540", bold: true, color: "FFFFFF", width: 3800 }),
                            wTableCell("Result", { fill: "1C2540", bold: true, color: "FFFFFF", width: 2800 }),
                            wTableCell("Points", { fill: "1C2540", bold: true, color: "FFFFFF", width: 2640 }),
                        ], true),
                        ...ansEntries.map(([, ans]) => wTableRow([
                            wTableCell(ans.name || "?", { width: 3800 }),
                            wTableCell(ans.correct ? "Correct" : "Wrong", {
                                width: 2800,
                                color: ans.correct ? "2E7D32" : "B71C1C",
                                bold: true
                            }),
                            wTableCell(ans.correct ? `+${ans.pts}` : "-", {
                                width: 2640,
                                color: ans.correct ? "2E7D32" : "999999"
                            }),
                        ]))
                    ];
                    body.push(wTable(ansRows, [3800, 2800, 2640]));
                } else {
                    body.push(wPara(wRun("No answers recorded.", { color: "999999", size: 20 })));
                }

                body.push(wPara(""));
            });
        }

        // ‚îÄ‚îÄ Assemble document.xml ‚îÄ‚îÄ
        const documentXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
    xmlns:cx="http://schemas.microsoft.com/office/drawing/2014/chartex"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:aink="http://schemas.microsoft.com/office/drawing/2016/ink"
    xmlns:am3d="http://schemas.microsoft.com/office/drawing/2017/model3d"
    xmlns:o="urn:schemas-microsoft-com:office:office"
    xmlns:oel="http://schemas.microsoft.com/office/2019/extlst"
    xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
    xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"
    xmlns:v="urn:schemas-microsoft-com:vml"
    xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing"
    xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
    xmlns:w10="urn:schemas-microsoft-com:office:word"
    xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
    xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml"
    xmlns:w15="http://schemas.microsoft.com/office/word/2012/wordml"
    xmlns:w16cex="http://schemas.microsoft.com/office/word/2018/wordml/cex"
    xmlns:w16cid="http://schemas.microsoft.com/office/word/2016/wordml/cid"
    xmlns:w16="http://schemas.microsoft.com/office/word/2018/wordml"
    xmlns:w16sdtdh="http://schemas.microsoft.com/office/word/2020/wordml/sdtdatahash"
    xmlns:w16se="http://schemas.microsoft.com/office/word/2015/wordml/symex"
    xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup"
    xmlns:wpi="http://schemas.microsoft.com/office/word/2010/wordprocessingInk"
    xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml"
    xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape"
    mc:Ignorable="w14 w15 w16se w16cid w16 w16cex w16sdtdh wp14">
<w:body>${body.join("")}<w:sectPr>
    <w:pgSz w:w="12240" w:h="15840"/>
    <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="708" w:footer="708" w:gutter="0"/>
</w:sectPr></w:body></w:document>`;

        // ‚îÄ‚îÄ Styles XML ‚îÄ‚îÄ
        const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
    xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" w:docDefaults="">
<w:docDefaults><w:rPrDefault><w:rPr>
    <w:rFonts w:ascii="Calibri" w:eastAsia="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/>
    <w:sz w:val="24"/><w:szCs w:val="24"/>
</w:rPr></w:rPrDefault></w:docDefaults>
<w:style w:type="paragraph" w:styleId="Normal"><w:name w:val="Normal"/></w:style>
<w:style w:type="paragraph" w:styleId="Heading1"><w:name w:val="heading 1"/>
<w:basedOn w:val="Normal"/><w:next w:val="Normal"/>
<w:pPr><w:spacing w:before="240" w:after="120"/></w:pPr>
<w:rPr><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/>
<w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/></w:rPr></w:style>
<w:style w:type="paragraph" w:styleId="Heading2"><w:name w:val="heading 2"/>
<w:basedOn w:val="Normal"/><w:next w:val="Normal"/>
<w:pPr><w:spacing w:before="200" w:after="100"/></w:pPr>
<w:rPr><w:b/><w:bCs/><w:sz w:val="32"/><w:szCs w:val="32"/>
<w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/></w:rPr></w:style>
<w:style w:type="paragraph" w:styleId="Heading3"><w:name w:val="heading 3"/>
<w:basedOn w:val="Normal"/><w:next w:val="Normal"/>
<w:pPr><w:spacing w:before="160" w:after="80"/></w:pPr>
<w:rPr><w:b/><w:bCs/><w:sz w:val="26"/><w:szCs w:val="26"/>
<w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/></w:rPr></w:style>
<w:style w:type="table" w:styleId="TableGrid"><w:name w:val="Table Grid"/>
<w:tblPr><w:tblBorders>
    <w:top w:val="single" w:sz="4" w:space="0" w:color="auto"/>
    <w:left w:val="single" w:sz="4" w:space="0" w:color="auto"/>
    <w:bottom w:val="single" w:sz="4" w:space="0" w:color="auto"/>
    <w:right w:val="single" w:sz="4" w:space="0" w:color="auto"/>
    <w:insideH w:val="single" w:sz="4" w:space="0" w:color="auto"/>
    <w:insideV w:val="single" w:sz="4" w:space="0" w:color="auto"/>
</w:tblBorders></w:tblPr></w:style>
</w:styles>`;

        // ‚îÄ‚îÄ [Content_Types].xml ‚îÄ‚îÄ
        const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
<Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

        // ‚îÄ‚îÄ _rels/.rels ‚îÄ‚îÄ
        const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

        // ‚îÄ‚îÄ word/_rels/document.xml.rels ‚îÄ‚îÄ
        const wordRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

        // ‚îÄ‚îÄ Build ZIP ‚îÄ‚îÄ
        DocxZip.reset();
        DocxZip.add("[Content_Types].xml", contentTypes);
        DocxZip.add("_rels/.rels", rels);
        DocxZip.add("word/document.xml", documentXml);
        DocxZip.add("word/styles.xml", stylesXml);
        DocxZip.add("word/_rels/document.xml.rels", wordRels);

        const zipBytes = DocxZip.build();
        const blob = new Blob([zipBytes], { type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `quiz-battle-${S.roomId}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 1000);

        toast(t("exported"), "ok");
    } catch(err){
        console.error("DOCX export error:", err);
        toast(t("exportFail") + ": " + (err.message || "unknown"), "err");
    } finally {
        btn.disabled = false;
        btn.innerHTML = origHTML;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openStats(){
    const body = el("stats-body"); body.innerHTML = "";

    if(!S.finData || !S.qLog.length){
        body.innerHTML = `<p style="color:var(--muted);text-align:center;padding:28px 0">${t("noStats")}</p>`;
        openM("modal-stats"); return;
    }

    const players = (S.finData.leaderboard||[]).map(p => ({
        uid: p.user_id, name: p.first_name,
        teamColor: (S.teams[p.team]||{}).color || "#aaa",
    }));

    S.qLog.forEach((q, qi) => {
        if(!q || !q.text) return;
        const block = document.createElement("div");
        block.className = "stats-q-block";

        const opts = q.options || [];
        const correctText = (q.correct_idx >= 0 && opts[q.correct_idx])
            ? `‚úÖ ${t("correctAns")}: ${LETTERS[q.correct_idx]}. ${opts[q.correct_idx]}`
            : "";

        let rows = "";
        for(const pl of players){
            const ans = q.answers[pl.uid];
            if(ans){
                rows += `<div class="stats-row">
                    <div class="s-av" style="background:${ans.teamColor}">${(pl.name||"?")[0].toUpperCase()}</div>
                    <span class="s-name">${pl.name}</span>
                    <span class="s-badge ${ans.correct?"ok":"no"}">${ans.correct ? t("correctLabel") : t("wrongLabel")}</span>
                    <span class="s-pts ${ans.correct?"earned":"zero"}">${ans.correct?"+"+ans.pts:"‚Äî"}</span>
                </div>`;
            } else {
                rows += `<div class="stats-row">
                    <div class="s-av" style="background:${pl.teamColor}">${(pl.name||"?")[0].toUpperCase()}</div>
                    <span class="s-name">${pl.name}</span>
                    <span class="s-badge sk">${t("skipped")}</span>
                    <span class="s-pts zero">‚Äî</span>
                </div>`;
            }
        }

        block.innerHTML = `<div class="stats-q-num">Q${qi+1} / ${S.qLog.length}</div>
            <div class="stats-q-text">${q.text}</div>
            ${correctText ? `<div class="stats-correct-ans">${correctText}</div>` : ""}
            ${rows}`;
        body.appendChild(block);
    });

    openM("modal-stats");
    setTimeout(() => { body.scrollTop = 0; }, 100);
}

function goBack(){
    if(tg?.close) tg.close();
    if(tg?.openTelegramLink){
        tg.openTelegramLink(BOT_URL);
    } else {
        window.location.href = BOT_URL;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openM(id){ document.getElementById(id).classList.add("open"); }
function closeM(id){ document.getElementById(id).classList.remove("open"); }
function bgClose(e, id){ if(e.target === document.getElementById(id)) closeM(id); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showState(id){
    document.querySelectorAll(".state").forEach(e2 => e2.classList.remove("active"));
    document.getElementById(id)?.classList.add("active");
}
function showErr(msg, showHint = false){
    showState("s-error");
    setText("err-msg", msg);
    const hint = el("err-hint");
    if(showHint){
        hint.textContent = t("roomEndedHint");
        hint.style.display = "block";
    } else {
        hint.style.display = "none";
    }
}
function el(id){ return document.getElementById(id); }
function setText(id, txt){ const e2 = document.getElementById(id); if(e2) e2.textContent = txt; }

let _tt;
function toast(msg, type="inf"){
    const e2 = el("toast");
    e2.textContent = msg; e2.className = `toast show ${type}`;
    clearTimeout(_tt); _tt = setTimeout(() => e2.classList.remove("show"), 2800);
}

init();
</script>
</body>
</html>